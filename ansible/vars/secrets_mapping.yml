---
# Mapping of CI/CD environment variables to Ansible variables
# All secrets should be provided via environment variables in CI/CD
# DO NOT store actual secrets in this file

secrets:
  # K3s cluster token
  k3s:
    token: "{{ lookup('env', 'K3S_TOKEN') | default(omit) }}"

  # Vault secrets
  vault:
    root_token: "{{ lookup('env', 'VAULT_ROOT_TOKEN') | default(omit) }}"
    unseal_keys: "{{ lookup('env', 'VAULT_UNSEAL_KEYS') | default('[]') | from_json }}"

  # Database credentials
  postgresql:
    superuser_password: "{{ lookup('env', 'POSTGRES_SUPERUSER_PASSWORD') | default(omit) }}"
    replication_password: "{{ lookup('env', 'POSTGRES_REPLICATION_PASSWORD') | default(omit) }}"

  mariadb:
    root_password: "{{ lookup('env', 'MARIADB_ROOT_PASSWORD') | default(omit) }}"
    replication_password: "{{ lookup('env', 'MARIADB_REPLICATION_PASSWORD') | default(omit) }}"

  redis:
    password: "{{ lookup('env', 'REDIS_PASSWORD') | default(omit) }}"

  # Service credentials
  mattermost:
    admin_password: "{{ lookup('env', 'MATTERMOST_ADMIN_PASSWORD') | default(omit) }}"

  nextcloud:
    admin_password: "{{ lookup('env', 'NEXTCLOUD_ADMIN_PASSWORD') | default(omit) }}"

  gitea:
    admin_password: "{{ lookup('env', 'GITEA_ADMIN_PASSWORD') | default(omit) }}"

  argocd:
    admin_password: "{{ lookup('env', 'ARGOCD_ADMIN_PASSWORD') | default(omit) }}"

  grafana:
    admin_password: "{{ lookup('env', 'GRAFANA_ADMIN_PASSWORD') | default(omit) }}"

  redcap:
    salt: "{{ lookup('env', 'REDCAP_SALT') | default(omit) }}"

  flipt:
    # Flipt uses database auth, no additional secrets needed

  seaweedfs:
    s3_access_key: "{{ lookup('env', 'SEAWEEDFS_S3_ACCESS_KEY') | default(omit) }}"
    s3_secret_key: "{{ lookup('env', 'SEAWEEDFS_S3_SECRET_KEY') | default(omit) }}"

  onlyoffice:
    jwt_secret: "{{ lookup('env', 'ONLYOFFICE_JWT_SECRET') | default(omit) }}"

  # Authelia OIDC secrets
  authelia:
    jwt_secret: "{{ lookup('env', 'AUTHELIA_JWT_SECRET') | default(omit) }}"
    session_secret: "{{ lookup('env', 'AUTHELIA_SESSION_SECRET') | default(omit) }}"
    storage_key: "{{ lookup('env', 'AUTHELIA_STORAGE_KEY') | default(omit) }}"
    oidc_hmac_secret: "{{ lookup('env', 'AUTHELIA_OIDC_HMAC_SECRET') | default(omit) }}"
    oidc_private_key: "{{ lookup('env', 'AUTHELIA_OIDC_PRIVATE_KEY') | default(omit) }}"
    # OIDC client secrets
    oidc_ecrin_secret: "{{ lookup('env', 'AUTHELIA_OIDC_ECRIN_SECRET') | default(omit) }}"

  # TLS/Let's Encrypt
  letsencrypt:
    email: "{{ lookup('env', 'LETSENCRYPT_EMAIL') | default('admin@example.com') }}"

  # Longhorn encryption
  longhorn:
    crypto_key: "{{ lookup('env', 'LONGHORN_CRYPTO_KEY') | default(omit) }}"

  # etcd encryption
  etcd:
    encryption_key: "{{ lookup('env', 'ETCD_ENCRYPTION_KEY') | default(omit) }}"

# Per-service database passwords
# SECURITY: Each service MUST have its own unique password
# NO FALLBACK to superuser password - this enforces proper secret management
database_passwords:
  vault: "{{ lookup('env', 'VAULT_DB_PASSWORD') }}"
  mattermost: "{{ lookup('env', 'MATTERMOST_DB_PASSWORD') }}"
  nextcloud: "{{ lookup('env', 'NEXTCLOUD_DB_PASSWORD') }}"
  gitea: "{{ lookup('env', 'GITEA_DB_PASSWORD') }}"
  redcap: "{{ lookup('env', 'REDCAP_DB_PASSWORD') }}"
  flipt: "{{ lookup('env', 'FLIPT_DB_PASSWORD') }}"
  authelia: "{{ lookup('env', 'AUTHELIA_DB_PASSWORD') }}"

# Database privilege levels per service
# Defines SQL privileges for each application user
# schema_owner: true = ALL PRIVILEGES (for apps that run migrations)
# schema_owner: false = SELECT, INSERT, UPDATE, DELETE only (minimal CRUD)
database_privileges:
  # Services requiring schema modifications (migrations)
  vault:
    privileges: "ALL PRIVILEGES"
    schema_owner: true

  # Standard CRUD services - no DDL permissions
  mattermost:
    privileges: "SELECT, INSERT, UPDATE, DELETE"
    schema_owner: false
  nextcloud:
    privileges: "SELECT, INSERT, UPDATE, DELETE"
    schema_owner: false
  gitea:
    privileges: "SELECT, INSERT, UPDATE, DELETE"
    schema_owner: false
  redcap:
    privileges: "SELECT, INSERT, UPDATE, DELETE"
    schema_owner: false
  flipt:
    privileges: "SELECT, INSERT, UPDATE, DELETE"
    schema_owner: false
  authelia:
    privileges: "SELECT, INSERT, UPDATE, DELETE"
    schema_owner: false

# Database names and users mapping
database_config:
  vault:
    database: vault
    user: vault_user
  mattermost:
    database: mattermost
    user: mattermost_user
  nextcloud:
    database: nextcloud
    user: nextcloud_user
  gitea:
    database: gitea
    user: gitea_user
  redcap:
    database: redcap
    user: redcap_user
  flipt:
    database: flipt
    user: flipt_user
  authelia:
    database: authelia
    user: authelia_user
