---
# Authelia configuration
# Lightweight SSO and forward auth for ATLAS platform

# Namespace
authelia_namespace: authelia

# Version (from centralized helm_versions.yml)
authelia_version: "{{ helm_versions.authelia }}"

# Domain configuration
authelia_host: "login.{{ domain }}"
authelia_cookie_domain: "{{ domain }}"

# Replicas
authelia_replicas: "{{ 2 if ha_enabled | default(false) else 1 }}"

# Resource limits
authelia_resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi

# TLS configuration
authelia_ingress_enabled: true
authelia_ingress_issuer: "{{ tls_issuer }}"

# Session configuration
authelia_session_name: atlas_session
authelia_session_expiration: 1h
authelia_session_inactivity: 5m
authelia_session_remember_me: 1M

# Redis backend (for session storage)
authelia_redis_enabled: true
authelia_redis_host: "{{ redis_host | default('redis-master.databases.svc.cluster.local') }}"
authelia_redis_port: 6379

# Storage backend (SQLite for simplicity, PostgreSQL for HA)
authelia_storage_backend: "{{ 'postgres' if ha_enabled | default(false) else 'local' }}"
authelia_postgresql_host: "{{ postgresql_host | default('postgresql.databases.svc.cluster.local') }}"
authelia_postgresql_port: 5432
authelia_postgresql_database: authelia
authelia_postgresql_username: authelia

# TOTP (2FA) configuration
authelia_totp_issuer: "ATLAS"
authelia_totp_period: 30
authelia_totp_skew: 1

# WebAuthn (FIDO2) configuration
authelia_webauthn_enabled: true
authelia_webauthn_display_name: "ATLAS Platform"

# Password policy
authelia_password_min_length: 12
authelia_password_require_uppercase: true
authelia_password_require_lowercase: true
authelia_password_require_number: true
authelia_password_require_special: true

# Default access policy
authelia_default_policy: deny

# User groups for access control
authelia_groups:
  - admins
  - devops
  - researchers
  - users

# Access control rules
# Override this in group_vars for environment-specific rules
authelia_access_rules:
  # Authentik UI - admins only with 2FA
  - domain: "auth.{{ domain }}"
    policy: two_factor
    subject:
      - "group:admins"

  # Vault - admins and devops with 2FA
  - domain: "vault.{{ domain }}"
    policy: two_factor
    subject:
      - "group:admins"
      - "group:devops"

  # REDCap - researchers with 2FA
  - domain: "redcap.{{ domain }}"
    policy: two_factor
    subject:
      - "group:researchers"
      - "group:admins"

  # Hubble UI - devops with 1FA
  - domain: "hubble.{{ domain }}"
    policy: one_factor
    subject:
      - "group:devops"
      - "group:admins"

  # ArgoCD - devops with 2FA
  - domain: "argocd.{{ domain }}"
    policy: two_factor
    subject:
      - "group:devops"
      - "group:admins"

  # Grafana - all authenticated users
  - domain: "grafana.{{ domain }}"
    policy: one_factor

  # Gitea - all authenticated users
  - domain: "git.{{ domain }}"
    policy: one_factor

  # Nextcloud - all authenticated users
  - domain: "cloud.{{ domain }}"
    policy: one_factor

  # Mattermost - all authenticated users
  - domain: "chat.{{ domain }}"
    policy: one_factor

# Default users (for development/testing)
# In production, use LDAP or file-based users with external secrets
authelia_default_users_enabled: "{{ env | default('local') == 'local' }}"
authelia_default_users:
  - username: admin
    displayname: Administrator
    groups:
      - admins
      - devops
    email: admin@{{ domain }}
  - username: developer
    displayname: Developer
    groups:
      - devops
    email: dev@{{ domain }}
  - username: researcher
    displayname: Researcher
    groups:
      - researchers
    email: researcher@{{ domain }}

# Notification backend
authelia_notification_backend: filesystem  # filesystem, smtp
authelia_smtp_host: ""
authelia_smtp_port: 587
authelia_smtp_sender: "authelia@{{ domain }}"

# Logging
authelia_log_level: info
authelia_log_format: json

# Metrics
authelia_metrics_enabled: true
authelia_metrics_port: 9959
