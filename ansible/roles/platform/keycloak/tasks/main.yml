# Keycloak deployment tasks (Keycloak Operator)
# Deploys Keycloak IAM via the official Keycloak Operator with CRD-based realm import

- name: Deploy Keycloak
  block:

    - name: Create Keycloak operator namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ keycloak_operator_namespace }}"
            labels:
              app.kubernetes.io/name: keycloak-operator

    - name: Create Keycloak namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ keycloak_namespace }}"
            labels:
              app.kubernetes.io/name: keycloak
              app.kubernetes.io/component: identity

    # --- Install Keycloak Operator CRDs and Deployment ---

    - name: Install Keycloak Operator CRDs
      kubernetes.core.k8s:
        state: present
        src: "https://raw.githubusercontent.com/keycloak/keycloak-k8s-resources/{{ keycloak_operator_version }}/kubernetes/keycloaks.k8s.keycloak.org-v1.yml"

    - name: Install KeycloakRealmImport CRD
      kubernetes.core.k8s:
        state: present
        src: "https://raw.githubusercontent.com/keycloak/keycloak-k8s-resources/{{ keycloak_operator_version }}/kubernetes/keycloakrealmimports.k8s.keycloak.org-v1.yml"

    - name: Install Keycloak Operator deployment
      kubernetes.core.k8s:
        state: present
        namespace: "{{ keycloak_operator_namespace }}"
        src: "https://raw.githubusercontent.com/keycloak/keycloak-k8s-resources/{{ keycloak_operator_version }}/kubernetes/kubernetes.yml"

    - name: Wait for Keycloak Operator to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        namespace: "{{ keycloak_operator_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=keycloak-operator
      register: kc_op_deployment
      until:
        - kc_op_deployment.resources | length > 0
        - kc_op_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    # --- Database setup ---

    - name: Create Keycloak database in PostgreSQL
      ansible.builtin.include_tasks: ../../platform/postgresql/tasks/create_database.yml
      vars:
        db_name: "{{ keycloak_postgresql_database }}"
        db_user: "{{ keycloak_postgresql_user }}"
        db_password: "{{ database_passwords.keycloak }}"
        db_privileges: "{{ database_privileges.keycloak.privileges }}"
        db_schema_owner: "{{ database_privileges.keycloak.schema_owner }}"
      when:
        - database_passwords.keycloak is defined
        - database_passwords.keycloak != ''

    # --- Vault-backed secrets management ---

    - name: Check if Keycloak secrets exist in Vault
      kubernetes.core.k8s_exec:
        namespace: "{{ namespaces.vault | default('vault') }}"
        pod: vault-0
        command: vault kv get -format=json {{ keycloak_vault_path }}
      environment:
        VAULT_TOKEN: "{{ secrets.vault.root_token }}"
      register: _vault_keycloak_check
      failed_when: false
      changed_when: false
      when: keycloak_vault_enabled | bool
      no_log: true

    - name: Generate and store Keycloak secrets in Vault
      when:
        - keycloak_vault_enabled | bool
        - _vault_keycloak_check.rc | default(1) != 0
      block:
        - name: Generate random secrets
          ansible.builtin.set_fact:
            _keycloak_generated_secrets:
              admin_password: "{{ keycloak_admin_password | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits,punctuation')) }}"
          no_log: true

        - name: Generate OIDC client secrets
          ansible.builtin.set_fact:
            _keycloak_client_secrets: >-
              {{
                _keycloak_client_secrets | default({})
                | combine({item.client_id: lookup('password', '/dev/null length=64 chars=ascii_letters,digits')})
              }}
          loop: "{{ keycloak_oidc_clients }}"
          no_log: true

        - name: Store Keycloak secrets in Vault
          kubernetes.core.k8s_exec:
            namespace: "{{ namespaces.vault | default('vault') }}"
            pod: vault-0
            command: >-
              vault kv put {{ keycloak_vault_path }}
              admin-password='{{ _keycloak_generated_secrets.admin_password }}'
              {% for client in keycloak_oidc_clients %}
              oidc-{{ client.client_id }}-secret='{{ _keycloak_client_secrets[client.client_id] }}'
              {% endfor %}
          environment:
            VAULT_TOKEN: "{{ secrets.vault.root_token }}"
          no_log: true

    - name: Create ExternalSecret for Keycloak
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'external-secret.yml.j2') | from_yaml_all | list }}"
      when: keycloak_vault_enabled | bool

    - name: Wait for ExternalSecret to sync
      kubernetes.core.k8s_info:
        api_version: external-secrets.io/v1beta1
        kind: ExternalSecret
        name: keycloak-secrets
        namespace: "{{ keycloak_namespace }}"
      register: _keycloak_es_status
      until: >-
        _keycloak_es_status.resources | length > 0 and
        _keycloak_es_status.resources[0].status.conditions
        | default([])
        | selectattr('type', 'equalto', 'Ready')
        | selectattr('status', 'equalto', 'True')
        | list | length > 0
      retries: 12
      delay: 5
      when: keycloak_vault_enabled | bool

    # --- Fallback: direct K8s Secret (local dev without Vault) ---

    - name: Create Keycloak secrets (fallback without Vault)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: keycloak-credentials
            namespace: "{{ keycloak_namespace }}"
          type: Opaque
          stringData:
            admin-password: "{{ keycloak_admin_password | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits')) }}"
      when: not (keycloak_vault_enabled | bool)
      no_log: true

    - name: Create Keycloak DB credentials (fallback without Vault)
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: keycloak-db-credentials
            namespace: "{{ keycloak_namespace }}"
          type: Opaque
          stringData:
            username: "{{ keycloak_postgresql_user }}"
            password: "{{ database_passwords.keycloak | default(lookup('password', '/dev/null length=32 chars=ascii_letters,digits')) }}"
      when: not (keycloak_vault_enabled | bool)
      no_log: true

    # --- Deploy Keycloak via Operator CRD ---

    - name: Create Keycloak instance
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'keycloak.yml.j2') | from_yaml }}"

    - name: Wait for Keycloak to be ready
      kubernetes.core.k8s_info:
        api_version: k8s.keycloak.org/v2alpha1
        kind: Keycloak
        name: keycloak
        namespace: "{{ keycloak_namespace }}"
      register: keycloak_status
      until:
        - keycloak_status.resources | length > 0
        - keycloak_status.resources[0].status is defined
        - keycloak_status.resources[0].status.conditions is defined
        - keycloak_status.resources[0].status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
      retries: 60
      delay: 10

    # --- Realm configuration via KeycloakRealmImport CRD ---

    - name: Import ATLAS realm
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'keycloak-realm-import.yml.j2') | from_yaml }}"

    - name: Wait for realm import to complete
      kubernetes.core.k8s_info:
        api_version: k8s.keycloak.org/v2alpha1
        kind: KeycloakRealmImport
        name: atlas-realm
        namespace: "{{ keycloak_namespace }}"
      register: realm_import_status
      until:
        - realm_import_status.resources | length > 0
        - realm_import_status.resources[0].status is defined
        - realm_import_status.resources[0].status.conditions is defined
        - realm_import_status.resources[0].status.conditions | selectattr('type', 'equalto', 'Done') | selectattr('status', 'equalto', 'True') | list | length > 0
      retries: 30
      delay: 10

    # --- Ingress ---

    - name: Create Keycloak HTTPRoute
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'httproute.yml.j2') | from_yaml_all | list }}"
      when: keycloak_ingress_enabled

    - name: Display Keycloak information
      ansible.builtin.debug:
        msg: |
          Keycloak deployed successfully!

          Login URL: https://{{ keycloak_host }}
          Admin Console: https://{{ keycloak_host }}/admin/
          Realm: {{ keycloak_realm }}
          Namespace: {{ keycloak_namespace }}

          OIDC Discovery: https://{{ keycloak_host }}/realms/{{ keycloak_realm }}/.well-known/openid-configuration

          Self-registration: {{ keycloak_registration_enabled }}
          Email verification: {{ keycloak_email_verification_required }}
          Allowed email domains: {{ keycloak_allowed_email_domains | default('all') }}

          Groups: {{ keycloak_groups | join(', ') }}
          Default group: {{ keycloak_default_group }}

          OIDC clients: {{ keycloak_oidc_clients | map(attribute='client_id') | join(', ') }}
