---
apiVersion: k8s.keycloak.org/v2alpha1
kind: KeycloakRealmImport
metadata:
  name: atlas-realm
  namespace: {{ keycloak_namespace }}
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: realm-import
spec:
  keycloakCRName: keycloak
  realm:
    realm: {{ keycloak_realm }}
    enabled: true
    displayName: "ATLAS Platform"
    registrationAllowed: {{ keycloak_registration_enabled | lower }}
    verifyEmail: {{ keycloak_email_verification_required | lower }}
    loginWithEmailAllowed: true
    duplicateEmailsAllowed: false
    resetPasswordAllowed: true
    passwordPolicy: "length({{ keycloak_password_min_length }}) and upperCase(1) and digits(1) and specialChars(1)"
{% if keycloak_smtp_host | default('') != '' %}
    smtpServer:
      host: "{{ keycloak_smtp_host }}"
      port: "{{ keycloak_smtp_port }}"
      from: "{{ keycloak_smtp_from }}"
      starttls: "{{ keycloak_smtp_starttls | lower }}"
{% if keycloak_smtp_user | default('') != '' %}
      auth: "true"
      user: "{{ keycloak_smtp_user }}"
      password: "{{ keycloak_smtp_password }}"
{% else %}
      auth: "false"
{% endif %}
{% endif %}
    groups:
{% for group in keycloak_groups %}
      - name: {{ group }}
{% endfor %}
    defaultGroups:
      - "/{{ keycloak_default_group }}"
    clients:
{% for client in keycloak_oidc_clients %}
      - clientId: {{ client.client_id }}
        name: "{{ client.name }}"
        enabled: true
        publicClient: false
        standardFlowEnabled: true
        directAccessGrantsEnabled: false
        protocol: openid-connect
        redirectUris:
{% for uri in client.redirect_uris %}
          - "{{ uri }}"
{% endfor %}
        webOrigins:
{% for origin in client.web_origins | default([]) %}
          - "{{ origin }}"
{% endfor %}
        defaultClientScopes:
          - openid
          - profile
          - email
          - groups
{% endfor %}
