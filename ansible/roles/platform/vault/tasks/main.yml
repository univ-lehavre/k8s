---
# HashiCorp Vault tasks

- name: Create Vault namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ vault_namespace }}"
        labels:
          app.kubernetes.io/name: vault

- name: Add HashiCorp Helm repository
  kubernetes.core.helm_repository:
    name: "{{ vault_chart_repo_name }}"
    repo_url: "{{ vault_chart_repo }}"

- name: Deploy Vault via Helm
  kubernetes.core.helm:
    name: vault
    chart_ref: "{{ vault_chart_repo_name }}/vault"
    chart_version: "{{ helm_versions.vault }}"
    release_namespace: "{{ vault_namespace }}"
    create_namespace: true
    values: "{{ lookup('template', 'values.yml.j2') | from_yaml }}"
    wait: true
    wait_timeout: 600s

- name: Wait for Vault pod to be ready
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ vault_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=vault
      - component=server
  register: vault_pods
  until:
    - vault_pods.resources | length > 0
    - vault_pods.resources[0].status.phase == 'Running'
  retries: 30
  delay: 10

- name: Check Vault initialization status
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_namespace }}"
    pod: vault-0
    command: vault status -format=json
  register: vault_status_raw
  ignore_errors: true
  changed_when: false

- name: Parse Vault status
  ansible.builtin.set_fact:
    vault_initialized: "{{ (vault_status_raw.stdout | from_json).initialized | default(false) }}"
    vault_sealed: "{{ (vault_status_raw.stdout | from_json).sealed | default(true) }}"
  when: vault_status_raw.rc == 0 or vault_status_raw.rc == 2

- name: Initialize Vault (first time only)
  when:
    - not vault_initialized | default(false)
    - vault_root_token is not defined or vault_root_token == ''
  block:
    - name: Initialize Vault
      kubernetes.core.k8s_exec:
        namespace: "{{ vault_namespace }}"
        pod: vault-0
        command: >
          vault operator init
          -key-shares={{ vault_init_key_shares }}
          -key-threshold={{ vault_init_key_threshold }}
          -format=json
      register: vault_init_output

    - name: Parse init output
      ansible.builtin.set_fact:
        vault_init_data: "{{ vault_init_output.stdout | from_json }}"

    - name: Display Vault init credentials (SAVE THESE!)
      ansible.builtin.debug:
        msg: |
          =====================================================
          VAULT INITIALIZED - SAVE THESE CREDENTIALS SECURELY!
          =====================================================
          Root Token: {{ vault_init_data.root_token }}
          Unseal Keys: {{ vault_init_data.unseal_keys_b64 | join(', ') }}
          =====================================================
      when: vault_init_data is defined

- name: Unseal Vault
  kubernetes.core.k8s_exec:
    namespace: "{{ vault_namespace }}"
    pod: vault-0
    command: "vault operator unseal {{ item }}"
  loop: "{{ vault_unseal_keys[:vault_init_key_threshold] }}"
  when:
    - vault_sealed | default(true)
    - vault_unseal_keys | length >= vault_init_key_threshold
  no_log: true

- name: Create Vault Ingress
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'ingress.yml.j2') | from_yaml }}"
  when: vault_ingress_enabled

- name: Configure Vault (post-init)
  when:
    - vault_root_token is defined
    - vault_root_token != ''
  block:
    - name: Enable KV secrets engine
      kubernetes.core.k8s_exec:
        namespace: "{{ vault_namespace }}"
        pod: vault-0
        command: vault secrets enable -path=secret kv-v2
        env:
          - name: VAULT_TOKEN
            value: "{{ vault_root_token }}"
      register: kv_enable
      failed_when: false
      changed_when: kv_enable.rc == 0

    - name: Enable Kubernetes auth
      kubernetes.core.k8s_exec:
        namespace: "{{ vault_namespace }}"
        pod: vault-0
        command: vault auth enable kubernetes
        env:
          - name: VAULT_TOKEN
            value: "{{ vault_root_token }}"
      register: k8s_auth_enable
      failed_when: false
      changed_when: k8s_auth_enable.rc == 0

    - name: Configure Kubernetes auth
      kubernetes.core.k8s_exec:
        namespace: "{{ vault_namespace }}"
        pod: vault-0
        command: |
          vault write auth/kubernetes/config \
            kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
        env:
          - name: VAULT_TOKEN
            value: "{{ vault_root_token }}"
      when: k8s_auth_enable.changed or k8s_auth_enable.rc == 0
