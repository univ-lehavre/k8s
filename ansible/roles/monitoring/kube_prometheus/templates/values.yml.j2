# Kube-Prometheus Stack Helm Values
# Generated by Ansible

# Prometheus
prometheus:
  prometheusSpec:
    retention: {{ prometheus_retention }}
    retentionSize: {{ prometheus_retention_size }}

    resources:
      requests:
        cpu: {{ prometheus_resources.requests.cpu }}
        memory: {{ prometheus_resources.requests.memory }}
      limits:
        cpu: {{ prometheus_resources.limits.cpu }}
        memory: {{ prometheus_resources.limits.memory }}

    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: {{ prometheus_storage_class }}
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: {{ prometheus_storage_size }}

    # ServiceMonitor selector
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false

{% if prometheus_additional_scrape_configs | length > 0 %}
    additionalScrapeConfigs:
{{ prometheus_additional_scrape_configs | to_nice_yaml | indent(6) }}
{% endif %}

  ingress:
    enabled: {{ prometheus_ingress_enabled | lower }}
{% if prometheus_ingress_enabled %}
    ingressClassName: {{ grafana_ingress_class }}
    hosts:
      - {{ prometheus_ingress_host }}
    tls:
      - hosts:
          - {{ prometheus_ingress_host }}
        secretName: prometheus-tls
{% endif %}

# Alertmanager
alertmanager:
  enabled: {{ alertmanager_enabled | lower }}

  alertmanagerSpec:
    replicas: {{ alertmanager_replicas }}

    resources:
      requests:
        cpu: {{ alertmanager_resources.requests.cpu }}
        memory: {{ alertmanager_resources.requests.memory }}
      limits:
        cpu: {{ alertmanager_resources.limits.cpu }}
        memory: {{ alertmanager_resources.limits.memory }}

    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: {{ prometheus_storage_class }}
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: {{ alertmanager_storage_size }}

  ingress:
    enabled: {{ alertmanager_ingress_enabled | lower }}
{% if alertmanager_ingress_enabled %}
    ingressClassName: {{ grafana_ingress_class }}
    hosts:
      - {{ alertmanager_ingress_host }}
    tls:
      - hosts:
          - {{ alertmanager_ingress_host }}
        secretName: alertmanager-tls
{% endif %}

# Grafana
grafana:
  enabled: true

  adminUser: {{ grafana_admin_user }}
  adminPassword: "{{ grafana_admin_password }}"

  resources:
    requests:
      cpu: {{ grafana_resources.requests.cpu }}
      memory: {{ grafana_resources.requests.memory }}
    limits:
      cpu: {{ grafana_resources.limits.cpu }}
      memory: {{ grafana_resources.limits.memory }}

  persistence:
    enabled: true
    storageClassName: {{ prometheus_storage_class }}
    size: 10Gi

  grafana.ini:
    server:
      root_url: "https://{{ grafana_ingress_host }}"
{% if grafana_proxy_auth_enabled | default(false) %}
    # Proxy authentication via Authelia headers
    auth.proxy:
      enabled: true
      header_name: {{ grafana_proxy_header_name }}
      header_property: username
      auto_sign_up: {{ grafana_proxy_auto_sign_up | lower }}
      headers: "Email:{{ grafana_proxy_header_email }} Groups:{{ grafana_proxy_header_groups }}"
      enable_login_token: true
      sync_ttl: 60
    auth:
      disable_login_form: false
      disable_signout_menu: false
    users:
      auto_assign_org: true
      auto_assign_org_role: {{ grafana_role_mapping.default_role | default('Viewer') }}
    # Role mapping based on Authelia groups (JMESPath expression)
    # Maps groups header to Grafana roles: admins→Admin, devops→Editor, others→Viewer
    role_attribute_path: >-
      contains(groups[*], '{{ grafana_role_mapping.admin_groups | default(["admins"]) | join("') || contains(groups[*], '") }}') && 'Admin' ||
      contains(groups[*], '{{ grafana_role_mapping.editor_groups | default(["devops"]) | join("') || contains(groups[*], '") }}') && 'Editor' ||
      '{{ grafana_role_mapping.default_role | default("Viewer") }}'
    role_attribute_strict: false
{% elif grafana_oidc_enabled | default(false) %}
    # OIDC authentication via Authentik
    auth.generic_oauth:
      enabled: true
      name: {{ grafana_oidc_name }}
      allow_sign_up: true
      client_id: {{ grafana_oidc_client_id }}
      client_secret: ""  # Configure via External Secrets
      scopes: openid profile email groups
      auth_url: {{ grafana_oidc_auth_url }}
      token_url: {{ grafana_oidc_token_url }}
      api_url: {{ grafana_oidc_api_url }}
      role_attribute_path: >-
        contains(groups[*], '{{ grafana_role_mapping.admin_groups | default(["admins"]) | join("') || contains(groups[*], '") }}') && 'Admin' ||
        contains(groups[*], '{{ grafana_role_mapping.editor_groups | default(["devops"]) | join("') || contains(groups[*], '") }}') && 'Editor' ||
        'Viewer'
{% endif %}

  # Ingress disabled (managed separately)
  ingress:
    enabled: false

  # Sidecar for dashboards
  sidecar:
    dashboards:
      enabled: true
      searchNamespace: ALL
    datasources:
      enabled: true

# Prometheus Operator
prometheusOperator:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Node Exporter
nodeExporter:
  enabled: true

# Kube State Metrics
kubeStateMetrics:
  enabled: true

# Default rules
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: true
    general: true
    k8s: true
    kubeApiserver: true
    kubePrometheusGeneral: true
    kubePrometheusNodeAlerting: true
    kubePrometheusNodeRecording: true
    kubeScheduler: true
    kubeStateMetrics: true
    kubelet: true
    kubernetesAbsent: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    network: true
    node: true
    prometheus: true
    prometheusOperator: true
