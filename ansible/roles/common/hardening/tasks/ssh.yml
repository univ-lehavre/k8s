- name: Backup SSH configuration
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.bak
    remote_src: true
    mode: "0600"
  changed_when: false

- name: Configure SSH hardening
  ansible.builtin.template:
    src: sshd_hardening.conf.j2
    dest: /etc/ssh/sshd_config.d/hardening.conf
    mode: "0600"
    validate: "/usr/sbin/sshd -t -f %s"
  notify: Restart SSH

- name: Validate SSH configuration
  ansible.builtin.command: sshd -t
  changed_when: false
