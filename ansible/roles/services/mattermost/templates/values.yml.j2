# Mattermost Helm Values
# Generated by Ansible

image:
  repository: mattermost/mattermost-team-edition
  tag: "{{ mattermost_image_tag | default('9.11') }}"

resources:
  requests:
    cpu: {{ mattermost_resources.requests.cpu }}
    memory: {{ mattermost_resources.requests.memory }}
  limits:
    cpu: {{ mattermost_resources.limits.cpu }}
    memory: {{ mattermost_resources.limits.memory }}

livenessProbe:
  initialDelaySeconds: 30
  periodSeconds: 30
  httpGet:
    path: /api/v4/system/ping
    port: 8065

readinessProbe:
  initialDelaySeconds: 15
  periodSeconds: 10
  httpGet:
    path: /api/v4/system/ping
    port: 8065

persistence:
  data:
    enabled: true
    storageClass: {{ mattermost_storage_class }}
    size: {{ mattermost_storage_size }}
  plugins:
    enabled: true
    storageClass: {{ mattermost_storage_class }}
    size: 1Gi

# External database - uses service-specific password and SSL
externalDB:
  enabled: true
  externalDriverType: postgres
{% if postgresql_ssl_enabled | default(false) %}
  externalConnectionString: "postgres://{{ mattermost_postgresql_user }}:{{ database_passwords.mattermost }}@{{ mattermost_postgresql_host }}:{{ mattermost_postgresql_port }}/{{ mattermost_postgresql_database }}?sslmode=require"
{% else %}
  externalConnectionString: "postgres://{{ mattermost_postgresql_user }}:{{ database_passwords.mattermost }}@{{ mattermost_postgresql_host }}:{{ mattermost_postgresql_port }}/{{ mattermost_postgresql_database }}?sslmode=disable"
{% endif %}

# Disable built-in MySQL
mysql:
  enabled: false

# Site configuration
config:
  ServiceSettings:
    SiteURL: "https://{{ mattermost_ingress_host }}"
    EnableOpenServer: {{ (not mattermost_enable_signup) | lower }}
  TeamSettings:
    SiteName: "{{ mattermost_site_name }}"
{% if mattermost_oidc_enabled %}
  GitLabSettings:
    Enable: true
    Secret: ""  # Configure via External Secrets
    Id: "{{ mattermost_oidc_client_id }}"
    Scope: openid profile email groups
    AuthEndpoint: "https://login.{{ domain }}/api/oidc/authorization"
    TokenEndpoint: "https://login.{{ domain }}/api/oidc/token"
    UserApiEndpoint: "https://login.{{ domain }}/api/oidc/userinfo"
    DiscoveryEndpoint: "{{ mattermost_oidc_discovery_endpoint }}"
    ButtonText: "{{ mattermost_oidc_button_text }}"
    ButtonColor: "#6DB33F"
{% if mattermost_group_sync_enabled | default(true) %}
  # Group sync configuration for OIDC
  # Maps SSO groups to Mattermost roles
  GuestAccountsSettings:
    Enable: false
{% endif %}
{% endif %}

{% if mattermost_smtp_host | default('') != '' %}
  EmailSettings:
    SendEmailNotifications: true
    SMTPServer: "{{ mattermost_smtp_host }}"
    SMTPPort: "{{ mattermost_smtp_port }}"
    SMTPUsername: "{{ mattermost_smtp_user }}"
    SMTPPassword: "{{ mattermost_smtp_password }}"
    FeedbackEmail: "{{ mattermost_smtp_from }}"
    ConnectionSecurity: STARTTLS
{% endif %}

# Ingress disabled (managed separately)
ingress:
  enabled: false
