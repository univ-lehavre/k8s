# Nextcloud Helm Values
# Generated by Ansible

image:
  repository: nextcloud
  tag: "{{ nextcloud_image_tag | default('29') }}"

replicaCount: 1

resources:
  requests:
    cpu: {{ nextcloud_resources.requests.cpu }}
    memory: {{ nextcloud_resources.requests.memory }}
  limits:
    cpu: {{ nextcloud_resources.limits.cpu }}
    memory: {{ nextcloud_resources.limits.memory }}

# Admin credentials
nextcloud:
  host: {{ nextcloud_ingress_host }}
  existingSecret:
    enabled: true
    secretName: nextcloud-admin-credentials
    usernameKey: username
    passwordKey: password

  configs:
    proxy.config.php: |-
      <?php
      $CONFIG = array (
        'trusted_proxies' => array(
          0 => '127.0.0.1',
          1 => '10.0.0.0/8',
        ),
        'forwarded_headers' => array(
          0 => 'X-Forwarded-For',
          1 => 'X-Forwarded-Proto',
          2 => 'X-Forwarded-Host',
        ),
        'overwriteprotocol' => 'https',
      );
{% if nextcloud_s3_enabled %}
    s3.config.php: |-
      <?php
      $CONFIG = array (
        'objectstore' => array(
          'class' => '\\OC\\Files\\ObjectStore\\S3',
          'arguments' => array(
            'bucket' => '{{ nextcloud_s3_bucket }}',
            'hostname' => '{{ nextcloud_s3_host }}',
            'port' => {{ nextcloud_s3_port }},
            'use_ssl' => {{ nextcloud_s3_use_ssl | lower }},
            'use_path_style' => {{ nextcloud_s3_use_path_style | lower }},
            'autocreate' => true,
            'key' => '{{ seaweedfs_s3_access_key }}',
            'secret' => '{{ seaweedfs_s3_secret_key }}',
          ),
        ),
      );
{% endif %}

{% if nextcloud_smtp_host | default('') != '' %}
  mail:
    enabled: true
    fromAddress: "{{ nextcloud_smtp_from | regex_replace('@.*', '') }}"
    domain: "{{ domain }}"
    smtp:
      host: {{ nextcloud_smtp_host }}
      port: {{ nextcloud_smtp_port }}
      secure: {{ nextcloud_smtp_secure }}
      authtype: LOGIN
      name: {{ nextcloud_smtp_user }}
      password: "{{ nextcloud_smtp_password }}"
{% endif %}

  phpConfigs:
    uploadlimit.ini: |
      upload_max_filesize = 16G
      post_max_size = 16G

  livenessProbe:
    enabled: true
    initialDelaySeconds: 60
    periodSeconds: 30
  readinessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
  startupProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 5
    failureThreshold: 30

# Internal database disabled
internalDatabase:
  enabled: false

# External PostgreSQL - uses service-specific password
externalDatabase:
  enabled: true
  type: postgresql
{% if postgresql_ssl_enabled | default(false) %}
  host: "{{ nextcloud_postgresql_host }}?sslmode=require"
{% else %}
  host: {{ nextcloud_postgresql_host }}
{% endif %}
  port: {{ nextcloud_postgresql_port }}
  database: {{ nextcloud_postgresql_database }}
  user: {{ nextcloud_postgresql_user }}
  password: "{{ database_passwords.nextcloud }}"

# Redis for session and caching
redis:
  enabled: false

# External Redis
externalRedis:
  enabled: true
  host: {{ nextcloud_redis_host }}
  port: {{ nextcloud_redis_port }}
  password: "{{ redis_password }}"

# Persistence
persistence:
  enabled: true
  storageClass: {{ nextcloud_storage_class }}
  size: {{ nextcloud_storage_size }}

# Ingress disabled (managed separately)
ingress:
  enabled: false

# PHP settings
phpClientHttpsFix:
  enabled: true
  protocol: https

# Cron job
cronjob:
  enabled: true
