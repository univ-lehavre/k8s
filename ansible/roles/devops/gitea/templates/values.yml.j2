# Gitea Helm Values
# Generated by Ansible

replicaCount: 1

resources:
  requests:
    cpu: {{ gitea_resources.requests.cpu }}
    memory: {{ gitea_resources.requests.memory }}
  limits:
    cpu: {{ gitea_resources.limits.cpu }}
    memory: {{ gitea_resources.limits.memory }}

persistence:
  enabled: true
  storageClass: {{ gitea_storage_class }}
  size: {{ gitea_storage_size }}

# Gitea configuration
gitea:
  admin:
    username: {{ gitea_admin_user }}
    password: "{{ gitea_admin_password }}"
    email: {{ gitea_admin_email }}

  config:
    APP_NAME: "{{ organization_name | default('ATLAS') }} Git"
    RUN_MODE: prod

    server:
      DOMAIN: {{ gitea_ingress_host }}
      ROOT_URL: "https://{{ gitea_ingress_host }}/"
      SSH_DOMAIN: {{ gitea_ingress_host }}
      SSH_PORT: {{ gitea_ssh_port }}
      SSH_LISTEN_PORT: 22
      LFS_START_SERVER: {{ gitea_lfs_enabled | lower }}

    database:
      DB_TYPE: postgres
      HOST: {{ gitea_postgresql_host }}:{{ gitea_postgresql_port }}
      NAME: {{ gitea_postgresql_database }}
      USER: {{ gitea_postgresql_user }}
      PASSWD: "{{ database_passwords.gitea }}"
{% if postgresql_ssl_enabled | default(false) %}
      SSL_MODE: require
{% endif %}

    cache:
      ENABLED: true
      ADAPTER: redis
      HOST: "redis://:{{ redis_password }}@{{ gitea_redis_host }}:{{ gitea_redis_port }}/0"

    session:
      PROVIDER: redis
      PROVIDER_CONFIG: "redis://:{{ redis_password }}@{{ gitea_redis_host }}:{{ gitea_redis_port }}/1"

    queue:
      TYPE: redis
      CONN_STR: "redis://:{{ redis_password }}@{{ gitea_redis_host }}:{{ gitea_redis_port }}/2"

    security:
      INSTALL_LOCK: true
      SECRET_KEY: ""  # Will be auto-generated

    service:
      DISABLE_REGISTRATION: true
      REQUIRE_SIGNIN_VIEW: false
      DEFAULT_ALLOW_CREATE_ORGANIZATION: false

{% if gitea_smtp_host | default('') != '' %}
    mailer:
      ENABLED: true
      SMTP_ADDR: {{ gitea_smtp_host }}
      SMTP_PORT: {{ gitea_smtp_port }}
      FROM: {{ gitea_smtp_from }}
      USER: {{ gitea_smtp_user }}
      PASSWD: "{{ gitea_smtp_password }}"
      PROTOCOL: smtps
{% endif %}

{% if gitea_proxy_auth_enabled | default(false) %}
    # Reverse proxy authentication via SSO provider headers
    service:
      ENABLE_REVERSE_PROXY_AUTHENTICATION: true
      ENABLE_REVERSE_PROXY_AUTO_REGISTRATION: {{ gitea_proxy_auto_register | lower }}
      ENABLE_REVERSE_PROXY_EMAIL: true
      ENABLE_REVERSE_PROXY_FULL_NAME: true

    security:
      REVERSE_PROXY_AUTHENTICATION_USER: {{ gitea_proxy_header_name }}
      REVERSE_PROXY_AUTHENTICATION_EMAIL: {{ gitea_proxy_header_email }}
      REVERSE_PROXY_AUTHENTICATION_FULL_NAME: Remote-Name
      REVERSE_PROXY_TRUSTED_PROXIES: "*"
{% elif gitea_oidc_enabled | default(false) %}
    oauth2_client:
      OPENID_CONNECT_SCOPES: openid profile email groups
      ENABLE_AUTO_REGISTRATION: true
      USERNAME: nickname
      # Map groups claim from OIDC to Gitea roles
      GROUP_CLAIM_NAME: groups
      ADMIN_GROUP: {{ gitea_role_mapping.admin_groups | default(['admins']) | join(',') }}
{% if gitea_role_mapping.restricted_groups | default([]) | length > 0 %}
      RESTRICTED_GROUP: {{ gitea_role_mapping.restricted_groups | join(',') }}
{% endif %}
{% endif %}

  livenessProbe:
    enabled: true
    httpGet:
      path: /api/healthz
      port: http
    initialDelaySeconds: 30
    periodSeconds: 30
  readinessProbe:
    enabled: true
    httpGet:
      path: /api/healthz
      port: http
    initialDelaySeconds: 15
    periodSeconds: 10
  startupProbe:
    enabled: true
    httpGet:
      path: /api/healthz
      port: http
    initialDelaySeconds: 10
    periodSeconds: 5
    failureThreshold: 30

# Disable built-in PostgreSQL and Redis
postgresql:
  enabled: false

redis-cluster:
  enabled: false

# Ingress disabled (managed separately)
ingress:
  enabled: false

# Metrics
metrics:
  enabled: {{ monitoring_enabled | default(true) | lower }}
  serviceMonitor:
    enabled: {{ monitoring_enabled | default(true) | lower }}
