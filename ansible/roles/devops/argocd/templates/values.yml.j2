# ArgoCD Helm Values
# Generated by Ansible

global:
  domain: {{ argocd_ingress_host }}

{% if argocd_ha_enabled %}
# HA Configuration
controller:
  replicas: 2
  resources:
    requests:
      cpu: {{ argocd_controller_resources.requests.cpu }}
      memory: {{ argocd_controller_resources.requests.memory }}
    limits:
      cpu: {{ argocd_controller_resources.limits.cpu }}
      memory: {{ argocd_controller_resources.limits.memory }}
  pdb:
    enabled: true
    minAvailable: 1

server:
  replicas: 2
  resources:
    requests:
      cpu: {{ argocd_server_resources.requests.cpu }}
      memory: {{ argocd_server_resources.requests.memory }}
    limits:
      cpu: {{ argocd_server_resources.limits.cpu }}
      memory: {{ argocd_server_resources.limits.memory }}
  pdb:
    enabled: true
    minAvailable: 1

repoServer:
  replicas: 2
  resources:
    requests:
      cpu: {{ argocd_repo_server_resources.requests.cpu }}
      memory: {{ argocd_repo_server_resources.requests.memory }}
    limits:
      cpu: {{ argocd_repo_server_resources.limits.cpu }}
      memory: {{ argocd_repo_server_resources.limits.memory }}
  pdb:
    enabled: true
    minAvailable: 1

redis-ha:
  enabled: true
redis:
  enabled: false

{% else %}
# Non-HA Configuration
controller:
  resources:
    requests:
      cpu: {{ argocd_controller_resources.requests.cpu }}
      memory: {{ argocd_controller_resources.requests.memory }}
    limits:
      cpu: {{ argocd_controller_resources.limits.cpu }}
      memory: {{ argocd_controller_resources.limits.memory }}

server:
  resources:
    requests:
      cpu: {{ argocd_server_resources.requests.cpu }}
      memory: {{ argocd_server_resources.requests.memory }}
    limits:
      cpu: {{ argocd_server_resources.limits.cpu }}
      memory: {{ argocd_server_resources.limits.memory }}

repoServer:
  resources:
    requests:
      cpu: {{ argocd_repo_server_resources.requests.cpu }}
      memory: {{ argocd_repo_server_resources.requests.memory }}
    limits:
      cpu: {{ argocd_repo_server_resources.limits.cpu }}
      memory: {{ argocd_repo_server_resources.limits.memory }}
{% endif %}

configs:
  params:
    server.insecure: true  # TLS termination at ingress

{% if argocd_admin_password_hash is defined and argocd_admin_password_hash.stdout is defined %}
  secret:
    argocdServerAdminPassword: "{{ argocd_admin_password_hash.stdout }}"
{% endif %}

{% if argocd_oidc_enabled %}
  cm:
    url: "https://{{ argocd_ingress_host }}"
    oidc.config: |
      name: {{ argocd_oidc_name }}
      issuer: {{ argocd_oidc_issuer }}
      clientID: {{ argocd_oidc_client_id }}
      clientSecret: $oidc.keycloak.clientSecret
      requestedScopes:
{% for scope in argocd_oidc_requested_scopes %}
        - {{ scope }}
{% endfor %}
{% endif %}

  rbac:
    policy.default: {{ argocd_rbac_default_policy }}
    scopes: {{ argocd_rbac_scopes }}
    policy.csv: |
      # ArgoCD RBAC Policy
      g, argocd-admins, role:admin
      g, argocd-users, role:readonly

# Ingress disabled (managed separately)
server:
  ingress:
    enabled: false

# Metrics
metrics:
  enabled: {{ monitoring_enabled | default(true) | lower }}
  serviceMonitor:
    enabled: {{ monitoring_enabled | default(true) | lower }}
