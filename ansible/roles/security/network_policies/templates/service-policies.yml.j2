# Service-specific Network Policies
# Generated by Ansible

---
{% if network_policy_l7_enabled | default(false) %}
# PostgreSQL: L7-aware access control
# Each service can ONLY access its designated database
{% for policy in postgresql_l7_policies %}
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgresql-ingress-{{ policy.service }}
  namespace: {{ namespaces.postgresql }}
spec:
  description: "Allow {{ policy.service }} to access only {{ policy.database }} database"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ policy.namespace }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
          rules:
            l7proto: postgres
            l7:
              - action: Allow

---
{% endfor %}
# PostgreSQL: Allow internal replication
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgresql-replication
  namespace: {{ namespaces.postgresql }}
spec:
  description: "Allow PostgreSQL replication between replicas"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  ingress:
    - fromEndpoints:
        - matchLabels:
            app.kubernetes.io/name: postgresql
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
# PostgreSQL: Allow Prometheus metrics scraping
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgresql-metrics
  namespace: {{ namespaces.postgresql }}
spec:
  description: "Allow Prometheus to scrape PostgreSQL metrics"
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ monitoring_namespace }}
      toPorts:
        - ports:
            - port: "9187"
              protocol: TCP

---
{% else %}
# PostgreSQL: Allow connections from applications (L4 only)
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgresql-ingress
  namespace: {{ namespaces.postgresql }}
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: vault
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: keycloak
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: mattermost
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: nextcloud
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: gitea
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: redcap
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: flipt
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
{% endif %}
# Redis: Allow connections from applications
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: redis-ingress
  namespace: {{ namespaces.redis }}
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: keycloak
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: nextcloud
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: gitea
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP

---
# Vault: Allow connections from ESO and applications
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: vault-ingress
  namespace: vault
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: vault
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: external-secrets
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8200"
              protocol: TCP

---
# Web services: Allow ingress from Cilium ingress controller
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: mattermost
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8065"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: nextcloud
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: gitea
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "3000"
              protocol: TCP
            - port: "22"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: argocd
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
            - port: "443"
              protocol: TCP

---
# SeaweedFS: Allow from Nextcloud
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: seaweedfs-ingress
  namespace: seaweedfs
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: nextcloud
      toPorts:
        - ports:
            - port: "8333"
              protocol: TCP
            - port: "8888"
              protocol: TCP

---
# Mattermost egress to PostgreSQL
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: mattermost-egress
  namespace: mattermost
spec:
  endpointSelector: {}
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.postgresql }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
# Nextcloud egress to PostgreSQL, Redis, and SeaweedFS
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: nextcloud-egress
  namespace: nextcloud
spec:
  endpointSelector: {}
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.postgresql }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.redis }}
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: seaweedfs
      toPorts:
        - ports:
            - port: "8333"
              protocol: TCP

---
# Gitea egress to PostgreSQL and Redis
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: gitea-egress
  namespace: gitea
spec:
  endpointSelector: {}
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.postgresql }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.redis }}
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP

---
# Vault egress to PostgreSQL
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: vault-egress
  namespace: vault
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: vault
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.postgresql }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
# ArgoCD egress (needs internal git and external access)
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: argocd-egress
  namespace: argocd
spec:
  endpointSelector: {}
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: gitea
      toPorts:
        - ports:
            - port: "3000"
              protocol: TCP
            - port: "22"
              protocol: TCP
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: keycloak
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
    # Allow HTTPS egress for external git repos
    - toCIDR:
        - 0.0.0.0/0
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
            - port: "22"
              protocol: TCP

---
# REDCap egress to MariaDB
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: redcap-egress
  namespace: redcap
spec:
  endpointSelector: {}
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.mariadb }}
      toPorts:
        - ports:
            - port: "3306"
              protocol: TCP

---
# Flipt egress to PostgreSQL
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: flipt-egress
  namespace: flipt
spec:
  endpointSelector: {}
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.postgresql }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
# Keycloak: Allow from ingress (for login portal and OIDC)
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: keycloak-ingress
  namespace: {{ keycloak_namespace | default('keycloak') }}
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  ingress:
    # Allow from Envoy Gateway (for login portal and OIDC callbacks)
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
# Keycloak egress to PostgreSQL
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: keycloak-egress
  namespace: {{ keycloak_namespace | default('keycloak') }}
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: keycloak
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.postgresql }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
