# Service-specific Network Policies
# Generated by Ansible

---
# PostgreSQL: Allow connections from applications
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: postgresql-ingress
  namespace: {{ namespaces.databases }}
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: vault
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: authentik
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: mattermost
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: nextcloud
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: gitea
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: redcap
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: flipt
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP

---
# Redis: Allow connections from applications
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: redis-ingress
  namespace: {{ namespaces.databases }}
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: authentik
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: nextcloud
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: gitea
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP

---
# Vault: Allow connections from ESO and applications
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: vault-ingress
  namespace: vault
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: vault
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: external-secrets
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8200"
              protocol: TCP

---
# Authentik: Allow from ingress and applications
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: authentik-ingress
  namespace: authentik
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: authentik
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "9000"
              protocol: TCP
            - port: "9443"
              protocol: TCP

---
# Authentik egress to PostgreSQL and Redis
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: authentik-egress
  namespace: authentik
spec:
  endpointSelector:
    matchLabels:
      app.kubernetes.io/name: authentik
  egress:
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.databases }}
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
            - port: "6379"
              protocol: TCP

---
# Web services: Allow ingress from Cilium ingress controller
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: mattermost
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8065"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: nextcloud
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: gitea
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "3000"
              protocol: TCP
            - port: "22"
              protocol: TCP

---
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: web-services-ingress
  namespace: argocd
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ ingress_namespace }}
      toPorts:
        - ports:
            - port: "8080"
              protocol: TCP
            - port: "443"
              protocol: TCP

---
# SeaweedFS: Allow from Nextcloud
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: seaweedfs-ingress
  namespace: seaweedfs
spec:
  endpointSelector: {}
  ingress:
    - fromEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: nextcloud
      toPorts:
        - ports:
            - port: "8333"
              protocol: TCP
            - port: "8888"
              protocol: TCP
