# Database Isolation Policies
# Generated by Ansible
#
# These policies enforce strict database access control:
# - Each service can ONLY access its designated database
# - Cross-service database access is explicitly denied
# - Defense-in-depth: even if credentials leak, network policies block access

{% if network_policy_l7_enabled | default(false) %}
---
# Cluster-wide policy: Deny cross-database access
# Services in application namespaces can only egress to their designated database
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: database-access-control
spec:
  description: "Enforce database access control - each service accesses only its database"
  endpointSelector:
    matchExpressions:
      - key: io.kubernetes.pod.namespace
        operator: In
        values:
{% for policy in postgresql_l7_policies %}
          - {{ policy.namespace }}
{% endfor %}
  egress:
    # Allow DNS resolution
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: kube-system
            k8s-app: kube-dns
      toPorts:
        - ports:
            - port: "53"
              protocol: UDP
            - port: "53"
              protocol: TCP
    # Allow PostgreSQL access (L7 filtered at PostgreSQL policy)
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.databases }}
            app.kubernetes.io/name: postgresql
      toPorts:
        - ports:
            - port: "5432"
              protocol: TCP
    # Allow Redis access (for services that need caching/sessions)
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: {{ namespaces.databases }}
            app.kubernetes.io/name: redis
      toPorts:
        - ports:
            - port: "6379"
              protocol: TCP
    # Allow MariaDB access (for MySQL-compatible services like REDCap)
    - toEndpoints:
        - matchLabels:
            k8s:io.kubernetes.pod.namespace: mariadb
            app.kubernetes.io/name: mariadb
      toPorts:
        - ports:
            - port: "3306"
              protocol: TCP

---
# Deny direct pod-to-pod communication within database namespace
# Only allow access through the service endpoints
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: deny-cross-db-direct-access
  namespace: {{ namespaces.databases }}
spec:
  description: "Deny direct pod-to-pod access within database namespace from external namespaces"
  endpointSelector: {}
  ingress:
    # Only allow from labeled application namespaces, not from arbitrary pods
    - fromEndpoints:
        - matchExpressions:
            - key: io.kubernetes.pod.namespace
              operator: NotIn
              values:
                - {{ namespaces.databases }}
{% endif %}
