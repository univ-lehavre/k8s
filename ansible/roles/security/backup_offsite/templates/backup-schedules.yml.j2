# Velero Backup Schedules
# Generated by Ansible

{% if backup_targets.postgresql.enabled | default(true) %}
---
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: postgresql-backup
  namespace: {{ velero_namespace }}
spec:
  schedule: "{{ backup_targets.postgresql.schedule }}"
  template:
    includedNamespaces:
      - {{ backup_targets.postgresql.namespace }}
    includedResources:
      - persistentvolumeclaims
      - persistentvolumes
      - secrets
      - configmaps
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: postgresql
    ttl: {{ backup_targets.postgresql.retention }}
    storageLocation: default
    volumeSnapshotLocations:
      - default
{% endif %}

{% if backup_targets.vault.enabled | default(true) %}
---
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: vault-backup
  namespace: {{ velero_namespace }}
spec:
  schedule: "{{ backup_targets.vault.schedule }}"
  template:
    includedNamespaces:
      - {{ backup_targets.vault.namespace }}
    includedResources:
      - persistentvolumeclaims
      - persistentvolumes
      - secrets
      - configmaps
    ttl: {{ backup_targets.vault.retention }}
    storageLocation: default
    volumeSnapshotLocations:
      - default
{% endif %}

{% if backup_targets.kubernetes.enabled | default(true) %}
---
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: kubernetes-resources-backup
  namespace: {{ velero_namespace }}
spec:
  schedule: "{{ backup_targets.kubernetes.schedule }}"
  template:
    includedNamespaces:
{% for ns in backup_targets.kubernetes.namespaces %}
      - {{ ns }}
{% endfor %}
    includedResources:
      - deployments
      - statefulsets
      - daemonsets
      - services
      - ingresses
      - configmaps
      - secrets
      - serviceaccounts
      - roles
      - rolebindings
      - networkpolicies
    excludedResources:
      - events
      - pods
      - replicasets
    ttl: {{ backup_targets.kubernetes.retention }}
    storageLocation: default
{% endif %}

---
# Full cluster backup (weekly)
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: full-cluster-backup
  namespace: {{ velero_namespace }}
spec:
  schedule: "0 0 * * 0"  # Weekly on Sunday at midnight
  template:
    includedNamespaces:
      - "*"
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
      - {{ velero_namespace }}
    includedResources:
      - "*"
    excludedResources:
      - events
      - pods
      - replicasets
    ttl: "{{ backup_retention_months * 30 }}d"
    storageLocation: default
    volumeSnapshotLocations:
      - default
