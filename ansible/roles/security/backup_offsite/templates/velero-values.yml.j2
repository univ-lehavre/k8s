# Velero Helm Values
# Generated by Ansible

image:
  repository: velero/velero
  tag: v{{ velero_version }}

resources:
  requests:
    cpu: {{ backup_resources.requests.cpu }}
    memory: {{ backup_resources.requests.memory }}
  limits:
    cpu: {{ backup_resources.limits.cpu }}
    memory: {{ backup_resources.limits.memory }}

# Credentials from secret
credentials:
  useSecret: true
  existingSecret: velero-s3-credentials

configuration:
  backupStorageLocation:
    - name: default
      provider: aws
      bucket: {{ backup_s3_bucket }}
      config:
        region: {{ backup_s3_region }}
        s3Url: https://{{ backup_s3_endpoint }}
        s3ForcePathStyle: "true"
{% if backup_encryption_enabled %}
        serverSideEncryption: AES256
{% endif %}

  volumeSnapshotLocation:
    - name: default
      provider: aws
      config:
        region: {{ backup_s3_region }}

  # Default backup TTL
  defaultBackupTTL: "{{ backup_retention_days }}d"

  # Encryption
{% if backup_encryption_enabled %}
  extraEnvVars:
    VELERO_ENCRYPTION_KEY:
      valueFrom:
        secretKeyRef:
          name: velero-encryption-key
          key: encryption-key
{% endif %}

# Install AWS plugin
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v{{ helm_versions.velero_plugin_aws }}
    volumeMounts:
      - mountPath: /target
        name: plugins

# Enable Prometheus metrics
metrics:
  enabled: {{ monitoring_enabled | default(true) | lower }}
  serviceMonitor:
    enabled: {{ monitoring_enabled | default(true) | lower }}

# Schedule for garbage collection
schedules: {}
