# Déploiement intelligent avec résolution de dépendances
#
# Résout l'arbre de dépendances du composant cible, vérifie lesquels
# sont déjà opérationnels dans le cluster, et déploie uniquement
# les composants manquants dans l'ordre topologique.
#
# Usage :
#   ansible-playbook playbooks/deploy.yml -e target=mattermost
#   task deploy -- mattermost

- name: "ATLAS — Déploiement de {{ target | default('?') }}"
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../vars/helm_versions.yml
    - ../vars/secrets_mapping.yml
    - ../vars/dependency_graph.yml

  pre_tasks:
    - name: Valider la cible
      ansible.builtin.assert:
        that:
          - target is defined
          - target in atlas_components
        fail_msg: >-
          Cible "{{ target | default('non définie') }}" invalide. Composants disponibles : {{ atlas_components.keys() | sort | join(', ') }} #magic___^_^___line
    - name: Résoudre les dépendances
      ansible.builtin.set_fact:
        _deploy_order: "{{ atlas_components | resolve_deps(target) }}"

    - name: Afficher la chaîne de dépendances
      ansible.builtin.debug:
        msg: |
          Chaîne de déploiement pour {{ target }} :
            {{ _deploy_order | join(' → ') }}

          Vérification de l'état de chaque composant...

    - name: "Vérifier {{ item }}"
      ansible.builtin.include_tasks: ../tasks/check_component.yml
      vars:
        _component_name: "{{ item }}"
        _component_def: "{{ atlas_components[item] }}"
      loop: "{{ _deploy_order }}"
      register: _health_checks

    - name: Construire la liste des composants manquants
      ansible.builtin.set_fact:
        _to_deploy: >-
          {{ _deploy_order | select('in', _missing) | list }}
      vars:
        _missing: >-
          {{ _health_checks.results
             | selectattr('ansible_facts._component_healthy', 'defined')
             | rejectattr('ansible_facts._component_healthy')
             | map(attribute='item') | list }}

    - name: Afficher le plan d'exécution
      ansible.builtin.debug:
        msg: |
          {% if _to_deploy | length == 0 %}
          Tous les composants sont déjà en place. Rien à déployer.
          {% else %}
          Composants à déployer : {{ _to_deploy | join(' → ') }}
          Composants déjà OK   : {{ _deploy_order | difference(_to_deploy) | join(', ') | default('aucun') }}
          {% endif %}

    - name: Fin si rien à déployer
      ansible.builtin.meta: end_play
      when: _to_deploy | length == 0

  tasks:
    - name: "Déployer {{ item }}"
      ansible.builtin.include_role:
        name: "{{ atlas_components[item].role }}"
      loop: "{{ _to_deploy }}"
