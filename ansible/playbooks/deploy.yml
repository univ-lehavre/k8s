# Déploiement intelligent avec résolution de dépendances
#
# Résout l'arbre de dépendances du composant cible, vérifie lesquels
# sont déjà opérationnels dans le cluster, et déploie uniquement
# les composants manquants dans l'ordre topologique.
#
# Usage :
#   ansible-playbook -i inventories/staging/ playbooks/deploy.yml -e target=mattermost
#   task deploy:staging -- mattermost

# --- Play 1 : Résolution des dépendances et health checks ---
- name: "ATLAS — Résolution des dépendances pour {{ target | default('?') }}"
  hosts: localhost
  gather_facts: false
  become: false
  vars_files:
    - ../vars/versions.yml
    - ../vars/secrets_mapping.yml
    - ../vars/dependency_graph.yml
  environment:
    KUBECONFIG: >-
      {{ (k3s_type == 'k3s') | ternary(
        playbook_dir ~ '/../kubeconfig-' ~ env ~ '.yaml',
        lookup('env', 'KUBECONFIG') | default('', true)
      ) }}

  pre_tasks:
    - name: Valider la cible
      ansible.builtin.assert:
        that:
          - target is defined
          - target in atlas_components
        fail_msg: >-
          Cible "{{ target | default('non définie') }}" invalide. Composants disponibles : {{ atlas_components.keys() | sort | join(', ') }}

    - name: Résoudre les dépendances
      ansible.builtin.set_fact:
        _deploy_order: "{{ atlas_components | resolve_deps(target) }}"

    - name: Afficher la chaîne de dépendances
      ansible.builtin.debug:
        msg: |
          Chaîne de déploiement pour {{ target }} :
            {{ _deploy_order | join(' → ') }}

          Vérification de l'état de chaque composant...

    - name: "Vérifier les composants"
      ansible.builtin.include_tasks: ../tasks/check_component.yml
      vars:
        _component_name: "{{ item }}"
        _component_def: "{{ atlas_components[item] }}"
      loop: "{{ _deploy_order }}"

    - name: Construire la liste des composants manquants
      ansible.builtin.set_fact:
        _to_deploy: >-
          {{ _deploy_order | reject('in', _healthy) | list }}
      vars:
        _healthy: >-
          {{ _health_map | default({}) | dict2items
             | selectattr('value')
             | map(attribute='key') | list }}

    - name: Afficher le plan d'exécution
      ansible.builtin.debug:
        msg: |
          {% if _to_deploy | length == 0 %}
          Tous les composants sont déjà en place. Rien à déployer.
          {% else %}
          Composants à déployer : {{ _to_deploy | join(' → ') }}
          Composants déjà OK   : {{ _deploy_order | difference(_to_deploy) | join(', ') | default('aucun') }}
          {% endif %}

    - name: Fin si rien à déployer
      ansible.builtin.meta: end_play
      when: _to_deploy | length == 0

# --- Play 2 : Déploiement K3s sur les masters distants (staging/production) ---
- name: "ATLAS — Déploiement K3s Server"
  hosts: k3s_masters
  become: true
  gather_facts: true
  vars_files:
    - ../vars/versions.yml
    - ../vars/secrets_mapping.yml
    - ../vars/dependency_graph.yml

  roles:
    - role: k3s/server
      when:
        - "'k3s' in hostvars['localhost']['_to_deploy']"
        - k3s_type == 'k3s'

# --- Play 3 : Déploiement K3D en local (développement) ---
- name: "ATLAS — Déploiement K3D"
  hosts: localhost
  gather_facts: true
  become: false
  vars_files:
    - ../vars/versions.yml
    - ../vars/secrets_mapping.yml

  roles:
    - role: k3s/k3d
      when:
        - "'k3s' in _to_deploy"
        - k3s_type == 'k3d'

# --- Play 4 : Déploiement de tous les autres composants (localhost) ---
- name: "ATLAS — Déploiement des composants"
  hosts: localhost
  gather_facts: false
  become: false
  vars_files:
    - ../vars/versions.yml
    - ../vars/secrets_mapping.yml
    - ../vars/dependency_graph.yml
  environment:
    KUBECONFIG: >-
      {{ (k3s_type == 'k3s') | ternary(
        playbook_dir ~ '/../kubeconfig-' ~ env ~ '.yaml',
        lookup('env', 'KUBECONFIG') | default('', true)
      ) }}

  tasks:
    - name: "Déployer les composants"
      ansible.builtin.include_role:
        name: "{{ atlas_components[item].role }}"
      loop: "{{ _to_deploy | reject('equalto', 'k3s') | list }}"
      when: _to_deploy | length > 0
