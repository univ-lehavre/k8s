name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ansible-lint:
    name: Ansible Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible and collections
        run: |
          pip install ansible-core ansible-lint
          ansible-galaxy collection install -r ansible/requirements.yml

      - name: Run ansible-lint
        run: ansible-lint --profile=production

  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint -c .yamllint --strict .

  kubernetes-validate:
    name: Kubernetes Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin

      - name: Validate non-templated YAML manifests
        run: |
          find ansible/roles -name '*.yml' -not -name '*.j2' -not -path '*/tasks/*' \
            -not -path '*/defaults/*' -not -path '*/vars/*' -not -path '*/handlers/*' \
            -not -path '*/meta/*' | \
          xargs -r kubeconform -summary -strict \
            -ignore-missing-schemas \
            -kubernetes-version 1.29.0 \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            || true

  branch-up-to-date:
    name: Branch up to date
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch is not behind main
        run: |
          git fetch origin main
          BEHIND=$(git rev-list --count HEAD..origin/main)
          if [ "$BEHIND" -gt 0 ]; then
            echo "::error::Branch is $BEHIND commit(s) behind main. Rebase or merge main first."
            exit 1
          fi
          echo "Branch is up to date with main."

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run markdownlint
        uses: DavidAnson/markdownlint-cli2-action@v19
        with:
          globs: "**/*.md"
