---
# Taskfile pour le projet k8s
# Installation: brew install go-task/tap/go-task
# Utilisation: task --list
# Documentation: https://taskfile.dev

version: "3"

vars:
  ANSIBLE_DIR: ansible
  PROFILE: production
  REPORT_FILE: ansible-lint-report.json

tasks:
  default:
    desc: Afficher l'aide
    cmds:
      - task --list-all
    silent: true

  # Installation et configuration
  install-deps:
    desc: Installer toutes les d√©pendances
    cmds:
      - echo "üì¶ Installation des d√©pendances..."
      - echo "‚ÑπÔ∏è  ansible-lint et yamllint doivent √™tre install√©s via brew install ansible-lint yamllint"
      - ansible-galaxy install -r {{.ANSIBLE_DIR}}/requirements.yml
      - task: install-hooks
      - echo "‚úÖ D√©pendances install√©es"

  install-hooks:
    desc: Installer les git hooks avec lefthook
    cmds:
      - echo "ü™ù Installation des git hooks..."
      - lefthook install
      - echo "‚úÖ Git hooks install√©s"

  install-galaxy:
    desc: Installer les collections et r√¥les Ansible
    cmds:
      - echo "üì¶ Installation des collections Ansible..."
      - ansible-galaxy install -r {{.ANSIBLE_DIR}}/requirements.yml

  install-galaxy-update:
    desc: Mettre √† jour les collections et r√¥les Ansible
    cmds:
      - echo "üîÑ Mise √† jour des collections..."
      - ansible-galaxy install -r {{.ANSIBLE_DIR}}/requirements.yml --force
      - echo "‚úÖ Collections mises √† jour"

  # Linting
  lint:
    desc: Linter le projet Ansible
    cmds:
      - echo "üîç Linting du projet..."
      - ansible-lint --profile={{.PROFILE}}

  lint-fix:
    desc: Linter et corriger automatiquement
    cmds:
      - echo "üîß Linting avec auto-fix..."
      - ansible-lint --fix --profile={{.PROFILE}}

  lint-report:
    desc: G√©n√©rer un rapport de linting (format CodeClimate)
    cmds:
      - echo "üìä G√©n√©ration du rapport..."
      - ansible-lint --format=codeclimate > {{.REPORT_FILE}}
      - echo "‚úÖ Rapport g√©n√©r√© ‚Üí {{.REPORT_FILE}}"

  lint-file:
    desc: Linter un fichier sp√©cifique (usage - task lint-file -- path/to/file.yml)
    cmds:
      - ansible-lint --profile={{.PROFILE}} {{.CLI_ARGS}}

  lint-role:
    desc: Linter un r√¥le sp√©cifique (usage - task lint-role -- gitea)
    cmds:
      - ansible-lint --profile={{.PROFILE}} {{.ANSIBLE_DIR}}/roles/{{.CLI_ARGS}}

  # Validation YAML
  yaml-lint:
    desc: Valider la syntaxe YAML
    cmds:
      - echo "üìù Validation YAML..."
      - yamllint -c .yamllint --strict .

  yaml-fix:
    desc: Formater les fichiers YAML avec yamlfmt (si install√©)
    cmds:
      - |
        if command -v yamlfmt >/dev/null 2>&1; then
          yamlfmt -formatter retain_line_breaks=true .
        else
          echo "‚ö†Ô∏è  yamlfmt non install√©. Installer avec - go install github.com/google/yamlfmt/cmd/yamlfmt@latest"
        fi

  # V√©rification syntaxe Ansible
  syntax-check:
    desc: V√©rifier la syntaxe des playbooks
    cmds:
      - echo "üîç V√©rification de la syntaxe..."
      - for: { var: PLAYBOOKS, split: "\\n" }
        cmd: ansible-playbook --syntax-check {{.ITEM}}
      - echo "‚úÖ Syntaxe correcte"
    vars:
      PLAYBOOKS:
        sh: find {{.ANSIBLE_DIR}}/playbooks -name "*.yml" -type f 2>/dev/null || echo ""

  syntax-check-file:
    desc: V√©rifier la syntaxe d'un playbook sp√©cifique
    cmds:
      - ansible-playbook --syntax-check {{.CLI_ARGS}}

  # Checks combin√©s
  check:
    desc: Lancer tous les checks (lint + yamllint)
    deps:
      - lint
      - yaml-lint

  check-quick:
    desc: Check rapide (lint seulement)
    cmds:
      - task: lint

  # Git hooks
  hooks-test:
    desc: Tester les hooks pre-commit sur tous les fichiers
    cmds:
      - echo "ü™ù Test des hooks pre-commit..."
      - lefthook run pre-commit --all-files

  hooks-skip:
    desc: Exemple pour skip les hooks (info seulement)
    cmds:
      - echo "Pour bypasser les hooks-"
      - echo "  LEFTHOOK=0 git commit -m 'message'"
      - echo "  LEFTHOOK_EXCLUDE=ansible-lint git commit -m 'message'"
    silent: true

  # Nettoyage
  clean:
    desc: Nettoyer les fichiers temporaires
    cmds:
      - echo "üßπ Nettoyage..."
      - find . -type f -name '*.retry' -delete
      - find . -type d -name '__pycache__' -exec rm -rf {} + 2>/dev/null || true
      - find . -type d -name '.pytest_cache' -exec rm -rf {} + 2>/dev/null || true
      - rm -f {{.REPORT_FILE}}
      - echo "‚úÖ Nettoyage termin√©"

  clean-cache:
    desc: Nettoyer le cache ansible-lint
    cmds:
      - rm -rf .cache/
      - echo "‚úÖ Cache nettoy√©"

  # CI/CD
  ci:
    desc: Commande CI compl√®te
    cmds:
      - task: install-deps
      - task: check
      - echo "‚úÖ CI pass√©e avec succ√®s"

  ci-fast:
    desc: CI rapide (sans install)
    cmds:
      - task: check
      - echo "‚úÖ CI rapide pass√©e"

  # Debug et info
  info:
    desc: Afficher les informations sur l'environnement
    cmds:
      - echo "üìã Informations environnement-"
      - echo "  ansible-lint ‚Üí $(ansible-lint --version | head -1)"
      - echo "  yamllint ‚Üí $(yamllint --version 2>&1 || echo 'non install√©')"
      - echo "  lefthook ‚Üí $(lefthook version)"
      - echo "  ansible ‚Üí $(ansible --version | head -1)"
      - echo "  task ‚Üí $(task --version)"
    silent: true

  info-rules:
    desc: Lister toutes les r√®gles ansible-lint disponibles
    cmds:
      - ansible-lint -L

  info-rule:
    desc: Afficher les d√©tails d'une r√®gle (usage - task info-rule -- var-naming)
    cmds:
      - ansible-lint -T {{.CLI_ARGS}}

  # Profils de linting
  lint-min:
    desc: Linter avec profil minimal
    cmds:
      - ansible-lint --profile=min

  lint-basic:
    desc: Linter avec profil basic
    cmds:
      - ansible-lint --profile=basic

  lint-moderate:
    desc: Linter avec profil moderate
    cmds:
      - ansible-lint --profile=moderate

  lint-safety:
    desc: Linter avec profil safety (recommand√©)
    cmds:
      - ansible-lint --profile=safety

  lint-production:
    desc: Linter avec profil production (le plus strict)
    cmds:
      - ansible-lint --profile=production

  # Raccourcis
  format:
    desc: Formater automatiquement (alias lint-fix)
    cmds:
      - task: lint-fix

  fix:
    desc: Corriger automatiquement (alias lint-fix)
    cmds:
      - task: lint-fix

  test-hooks:
    desc: Tester les hooks (alias hooks-test)
    cmds:
      - task: hooks-test
