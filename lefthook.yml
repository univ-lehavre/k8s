---
# Configuration Lefthook pour le projet k8s
# Installation: lefthook install
# https://github.com/evilmartians/lefthook

# Configuration globale
colors: true
no_tty: false

# Pre-commit hooks
pre-commit:
  parallel: true # Ex√©cuter les commandes en parall√®le pour plus de vitesse

  commands:
    # Ansible Lint
    ansible-lint:
      glob: "*.{yml,yaml}"
      exclude: "(^\\.git/|^\\.cache/|^molecule/|^venv/)"
      run: ansible-lint --profile=production --force-color {staged_files}
      stage_fixed: true # Stage les fichiers fix√©s automatiquement

    # YAML Lint (optionnel, install√© si disponible)
    yamllint:
      glob: "*.{yml,yaml}"
      exclude: "(^\\.git/|^\\.cache/|^molecule/|^venv/)"
      run: |
        if command -v yamllint >/dev/null 2>&1; then
          yamllint -c .yamllint --strict {staged_files}
        else
          echo "‚ö†Ô∏è  yamllint not installed (optional). Install: pip install yamllint"
        fi

    # Markdown Lint
    markdownlint:
      glob: "*.md"
      exclude: "(^\\.git/|^node_modules/|^venv/)"
      run: |
        if command -v markdownlint-cli2 >/dev/null 2>&1; then
          markdownlint-cli2 {staged_files}
        else
          echo "‚ö†Ô∏è  markdownlint-cli2 not installed. Install: brew install markdownlint-cli2"
        fi

    # Trailing whitespace
    trailing-whitespace:
      glob: "*.{yml,yaml,md,sh,txt}"
      run: |
        if grep -n '[[:space:]]$' {staged_files}; then
          echo "‚ùå Trailing whitespace found in the above files"
          exit 1
        fi

    # Check for merge conflicts
    merge-conflicts:
      glob: "*"
      exclude: "(lefthook\\.yml$)" # Exclude self (contains pattern for detection)
      run: |
        if grep -rn '<''<<''<<<< HEAD' {staged_files}; then
          echo "‚ùå Merge conflict markers found"
          exit 1
        fi

# Pre-push hooks
pre-push:
  parallel: false

  commands:
    # Lint complet avant push
    full-ansible-lint:
      run: ansible-lint --profile=production

    # V√©rifier que nous ne pushons pas sur main/master sans protection
    protect-main:
      run: |
        branch=$(git rev-parse --abbrev-ref HEAD)
        if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
          echo "‚ö†Ô∏è  You're about to push to $branch. Are you sure? (Ctrl+C to cancel)"
          read -r response
        fi

# Prepare-commit-msg hooks (pour modifier les messages de commit avant validation)
prepare-commit-msg:
  commands:
    # Supprimer les lignes contenant des adresses email
    remove-emails:
      run: |
        commit_msg_file="{1}"
        # Supprimer les lignes contenant des adresses email
        sed -i.bak '/[a-zA-Z0-9._%+-]*@[a-zA-Z0-9.-]*\.[a-zA-Z]\{2,\}/d' "$commit_msg_file"
        rm -f "${commit_msg_file}.bak"

# Commit-msg hooks (pour valider les messages de commit)
commit-msg:
  commands:
    # Validation du format de message de commit (Conventional Commits)
    commitlint:
      run: |
        commit_msg=$(cat {1})
        # V√©rifier le format: type(scope): message
        if ! echo "$commit_msg" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+'; then
          echo "‚ùå Commit message must follow Conventional Commits format:"
          echo "   type(scope): description"
          echo ""
          echo "   Types: feat, fix, docs, style, refactor, perf, test, chore, ci, build, revert"
          echo ""
          echo "   Example: feat(gitea): add OIDC configuration"
          # Mettre en warning au lieu de bloquer
          # exit 1
        fi

# Post-checkout hooks
post-checkout:
  commands:
    # Afficher un rappel pour installer les d√©pendances
    dependencies-reminder:
      run: |
        if [ -f ansible/requirements.yml ]; then
          echo "üí° Don't forget to run: ansible-galaxy install -r ansible/requirements.yml"
        fi

# Post-merge hooks
post-merge:
  commands:
    # V√©rifier les d√©pendances apr√®s un merge
    check-requirements:
      run: |
        if git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep --quiet "ansible/requirements.yml"; then
          echo "‚ö†Ô∏è  ansible/requirements.yml has changed. Run: ansible-galaxy install -r ansible/requirements.yml"
        fi

# Configuration pour skip temporaire
# Utiliser: LEFTHOOK=0 git commit -m "message" pour skip tous les hooks
# Utiliser: LEFTHOOK_EXCLUDE=ansible-lint git commit pour skip un hook sp√©cifique
skip_output:
  - meta
  - success

# Exemples de commandes utiles:
# lefthook run pre-commit --all-files  # Linter tous les fichiers
# lefthook run ansible-lint            # Lancer seulement ansible-lint
# LEFTHOOK=0 git commit                # Skip tous les hooks
# LEFTHOOK_EXCLUDE=ansible-lint git commit  # Skip un hook sp√©cifique
